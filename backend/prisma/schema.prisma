// Prisma Schema for Clinic CRM
// Multi-tenant, production-grade schema with audit logging

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  SUPER_ADMIN
  CLINIC_ADMIN
  DOCTOR
  PATIENT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  COMPLETED_OFFLINE
  CANCELLED
  NO_SHOW
}

enum NotificationType {
  APPOINTMENT_CREATED
  APPOINTMENT_CONFIRMED
  APPOINTMENT_REMINDER_24H
  APPOINTMENT_REMINDER_2H
  APPOINTMENT_COMPLETED
  FEEDBACK_REQUEST
}

enum NotificationChannel {
  WHATSAPP
  DASHBOARD
  EMAIL
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  role         UserRole
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  clinicId String? @map("clinic_id")
  clinic   Clinic? @relation(fields: [clinicId], references: [id])

  doctor   Doctor?
  patient  Patient?
  auditLogs AuditLog[]
  notifications Notification[]

  @@index([email])
  @@index([clinicId])
  @@index([role])
  @@map("users")
}

model Clinic {
  id              String   @id @default(uuid())
  name            String
  address         String?
  phone           String?
  email           String?
  googleReviewUrl String?  @map("google_review_url")
  settings        Json     @default("{}")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  users          User[]
  doctorClinics  DoctorClinic[]
  specialists    Specialist[]
  patientClinics PatientClinic[]
  appointments   Appointment[]
  visitRecords   VisitRecord[]
  feedback       Feedback[]
  notifications  Notification[]
  auditLogs      AuditLog[]

  @@index([name])
  @@index([isActive])
  @@map("clinics")
}

model Doctor {
  id            String   @id @default(uuid())
  name          String
  qualification String?
  licenseNumber String?  @map("license_number")
  phone         String?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  doctorClinics     DoctorClinic[]
  doctorSpecialists DoctorSpecialist[]
  appointments      Appointment[]
  visitRecords      VisitRecord[]

  @@index([name])
  @@index([isActive])
  @@map("doctors")
}

model DoctorClinic {
  id        String   @id @default(uuid())
  schedule  Json     @default("{}") // { dayOfWeek: { startTime, endTime, slotDuration } }
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  doctorId String @map("doctor_id")
  doctor   Doctor @relation(fields: [doctorId], references: [id])
  clinicId String @map("clinic_id")
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  @@unique([doctorId, clinicId])
  @@index([clinicId])
  @@map("doctor_clinics")
}

model Specialist {
  id          String   @id @default(uuid())
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  clinicId String @map("clinic_id")
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  doctorSpecialists DoctorSpecialist[]
  appointments      Appointment[]

  @@unique([clinicId, name])
  @@index([clinicId])
  @@map("specialists")
}

model DoctorSpecialist {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  doctorId     String     @map("doctor_id")
  doctor       Doctor     @relation(fields: [doctorId], references: [id])
  specialistId String     @map("specialist_id")
  specialist   Specialist @relation(fields: [specialistId], references: [id])

  @@unique([doctorId, specialistId])
  @@map("doctor_specialists")
}

model Patient {
  id              String    @id @default(uuid())
  name            String
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  phone           String    @unique
  phoneEncrypted  String?   @map("phone_encrypted")
  dob             DateTime? @db.Date
  dobEncrypted    String?   @map("dob_encrypted")
  gender          Gender?
  bloodGroup      String?   @map("blood_group")
  email           String?
  allergies       String?   @db.Text
  medicalHistory  String?   @map("medical_history") @db.Text

  // Structured address (DPDP 2023)
  addressLine1    String?   @map("address_line_1")
  addressLine2    String?   @map("address_line_2")
  city            String?
  state           String?
  postalCode      String?   @map("postal_code")
  country         String?   @default("India")
  address         String?   @db.Text  // legacy flat address

  // Emergency contact
  emergencyName         String?  @map("emergency_name")
  emergencyRelationship String?  @map("emergency_relationship")
  emergencyPhone        String?  @map("emergency_phone")

  // Nominee (optional)
  nomineeName           String?  @map("nominee_name")
  nomineeRelationship   String?  @map("nominee_relationship")
  nomineePhone          String?  @map("nominee_phone")

  // Consent
  whatsappConsent Boolean   @default(false) @map("whatsapp_consent")
  consentAt       DateTime? @map("consent_at")
  dpdpConsent     Boolean   @default(false) @map("dpdp_consent")
  dpdpConsentAt   DateTime? @map("dpdp_consent_at")

  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  userId String? @unique @map("user_id")
  user   User?   @relation(fields: [userId], references: [id])

  patientClinics PatientClinic[]
  appointments   Appointment[]
  visitRecords   VisitRecord[]
  feedback       Feedback[]

  @@index([phone])
  @@index([name])
  @@index([createdAt])
  @@map("patients")
}

model PatientClinic {
  id         String   @id @default(uuid())
  firstVisit DateTime @default(now()) @map("first_visit")
  lastVisit  DateTime @default(now()) @map("last_visit")

  // Relations
  patientId String  @map("patient_id")
  patient   Patient @relation(fields: [patientId], references: [id])
  clinicId  String  @map("clinic_id")
  clinic    Clinic  @relation(fields: [clinicId], references: [id])

  @@unique([patientId, clinicId])
  @@index([clinicId])
  @@map("patient_clinics")
}

// ============================================================================
// APPOINTMENT & VISIT
// ============================================================================

model Appointment {
  id              String            @id @default(uuid())
  appointmentDate DateTime          @map("appointment_date") @db.Date
  startTime       DateTime          @map("start_time") @db.Time()
  endTime         DateTime          @map("end_time") @db.Time()
  status          AppointmentStatus @default(PENDING)
  notes           String?
  idempotencyKey  String?           @unique @map("idempotency_key")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  deletedAt       DateTime?         @map("deleted_at")

  // Relations
  clinicId     String      @map("clinic_id")
  clinic       Clinic      @relation(fields: [clinicId], references: [id])
  patientId    String      @map("patient_id")
  patient      Patient     @relation(fields: [patientId], references: [id])
  doctorId     String      @map("doctor_id")
  doctor       Doctor      @relation(fields: [doctorId], references: [id])
  specialistId String?     @map("specialist_id")
  specialist   Specialist? @relation(fields: [specialistId], references: [id])

  visitRecord   VisitRecord?
  feedback      Feedback?
  notifications Notification[]

  @@index([clinicId])
  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@index([status])
  @@index([clinicId, doctorId, appointmentDate])
  @@map("appointments")
}

model VisitRecord {
  id           String    @id @default(uuid())
  symptoms     String?   @db.Text
  diagnosis    String?   @db.Text
  notes        String?   @db.Text
  followUpDate DateTime? @map("follow_up_date") @db.Date
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  appointmentId String      @unique @map("appointment_id")
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  patientId     String      @map("patient_id")
  patient       Patient     @relation(fields: [patientId], references: [id])
  doctorId      String      @map("doctor_id")
  doctor        Doctor      @relation(fields: [doctorId], references: [id])
  clinicId      String      @map("clinic_id")
  clinic        Clinic      @relation(fields: [clinicId], references: [id])

  prescriptions Prescription[]
  attachments   Attachment[]

  @@index([clinicId])
  @@index([patientId])
  @@index([doctorId])
  @@map("visit_records")
}

model Prescription {
  id           String   @id @default(uuid())
  medication   String
  dosage       String?
  frequency    String?
  duration     String?
  instructions String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  visitRecordId String      @map("visit_record_id")
  visitRecord   VisitRecord @relation(fields: [visitRecordId], references: [id], onDelete: Cascade)

  @@index([visitRecordId])
  @@map("prescriptions")
}

model Attachment {
  id        String   @id @default(uuid())
  fileName  String   @map("file_name")
  fileType  String   @map("file_type")
  fileUrl   String   @map("file_url")
  fileSize  Int      @map("file_size")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  visitRecordId String      @map("visit_record_id")
  visitRecord   VisitRecord @relation(fields: [visitRecordId], references: [id], onDelete: Cascade)

  @@index([visitRecordId])
  @@map("attachments")
}

// ============================================================================
// FEEDBACK
// ============================================================================

model Feedback {
  id                 String   @id @default(uuid())
  rating             Int      // 1-5
  comments           String?  @db.Text
  isInternal         Boolean  @default(false) @map("is_internal")
  redirectedToGoogle Boolean  @default(false) @map("redirected_to_google")
  token              String   @unique // For feedback link validation
  tokenExpiresAt     DateTime @map("token_expires_at")
  submittedAt        DateTime? @map("submitted_at")
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  appointmentId String      @unique @map("appointment_id")
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  clinicId      String      @map("clinic_id")
  clinic        Clinic      @relation(fields: [clinicId], references: [id])
  patientId     String      @map("patient_id")
  patient       Patient     @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([token])
  @@map("feedback")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id           String             @id @default(uuid())
  type         NotificationType
  channel      NotificationChannel
  status       NotificationStatus @default(PENDING)
  externalId   String?            @map("external_id") // Interakt message ID
  payload      Json               @default("{}")
  errorMessage String?            @map("error_message") @db.Text
  retryCount   Int                @default(0) @map("retry_count")
  scheduledAt  DateTime?          @map("scheduled_at")
  sentAt       DateTime?          @map("sent_at")
  createdAt    DateTime           @default(now()) @map("created_at")

  // Relations
  clinicId      String       @map("clinic_id")
  clinic        Clinic       @relation(fields: [clinicId], references: [id])
  userId        String?      @map("user_id")
  user          User?        @relation(fields: [userId], references: [id])
  appointmentId String?      @map("appointment_id")
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  @@index([clinicId])
  @@index([status])
  @@index([scheduledAt])
  @@index([channel, status])
  @@map("notifications")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id         String      @id @default(uuid())
  entityType String      @map("entity_type")
  entityId   String      @map("entity_id")
  action     AuditAction
  oldValues  Json?       @map("old_values")
  newValues  Json?       @map("new_values")
  ipAddress  String?     @map("ip_address")
  userAgent  String?     @map("user_agent")
  createdAt  DateTime    @default(now()) @map("created_at")

  // Relations
  clinicId String? @map("clinic_id")
  clinic   Clinic? @relation(fields: [clinicId], references: [id])
  userId   String? @map("user_id")
  user     User?   @relation(fields: [userId], references: [id])

  @@index([clinicId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
